name: Create Branch on Issue Creation

on:
  issues:
    types: [opened]  # ì´ìŠˆê°€ ìƒì„±ë  ë•Œ ì‹¤í–‰ë¨

jobs:
  create-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Extract Branch Name from Issue Title
        id: extract_branch_name
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_TITLE="${{ github.event.issue.title }}"

          # ê¸°ë³¸ ë¸Œëœì¹˜ ë„¤ì´ë°
          BRANCH_NAME="issue_#${ISSUE_NUMBER}"

          # 1ï¸âƒ£ [FEAT]ì´ í¬í•¨ë˜ë©´ `dev_#ì´ìŠˆë²ˆí˜¸` í˜•ì‹ìœ¼ë¡œ ë¸Œëœì¹˜ ìƒì„±
          if echo "$ISSUE_TITLE" | grep -q "^\[FEAT\]"; then
            BRANCH_NAME="dev_#${ISSUE_NUMBER}"
          else
            # 2ï¸âƒ£ [ ] ì•ˆì˜ ê°’ì„ ì¶”ì¶œí•˜ì—¬ ì ‘ë‘ì–´ë¡œ ì‚¬ìš© (ì˜ˆ: [FIX] â†’ fix_#ì´ìŠˆë²ˆí˜¸)
            CATEGORY=$(echo "$ISSUE_TITLE" | grep -oP "(?<=\[).+?(?=\])" | head -n 1)

            if [[ -n "$CATEGORY" ]]; then
              CATEGORY_LOWER=$(echo "$CATEGORY" | tr '[:upper:]' '[:lower:]')  # ì†Œë¬¸ìë¡œ ë³€í™˜
              BRANCH_NAME="${CATEGORY_LOWER}_#${ISSUE_NUMBER}"
            fi
          fi

          # ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ ê³µë°± ë° íŠ¹ìˆ˜ë¬¸ì ì œê±°
          BRANCH_NAME=$(echo "$BRANCH_NAME" | tr ' ' '-' | tr -cd '[:alnum:]#_-')

          echo "ìµœì¢… ë¸Œëœì¹˜ ì´ë¦„: $BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Branch and Push
        run: |
          git fetch origin main
          git checkout -b "$BRANCH_NAME" origin/main
          git push origin "$BRANCH_NAME"

      - name: Comment on Issue
        uses: actions/github-script@v6
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const branch_name = process.env.BRANCH_NAME;
            const messages = [
              { text: `ğŸ¦„âœ¨ğŸ§šğŸ»â€â™€ï¸ ì½”ë“œ ìš”ì •ì´ ë§ˆë²• ì§€íŒ¡ì´ë¥¼ í”ë“¤ë”ë‹ˆâ€¦ âœ¨ ìƒˆë¡œìš´ ë¸Œëœì¹˜ê°€ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤! ì´ë¦„ì€ ë°”ë¡œ \`${branch_name}\`! ì–´ì„œ ê°€ì„œ ëª¨í—˜ì„ ì‹œì‘í•˜ì„¸ìš”!`, weight: 5 },
              { text: `ğŸ¤– ë¡œë´‡ì´ ì‚ë¹…- ì†Œë¦¬ë¥¼ ë‚´ë©° ë¸Œëœì¹˜ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ì‘ì—… êµ¬ì—­ì€ \`${branch_name}\`ì…ë‹ˆë‹¤. ì¸ê°„, ì½”ë“œë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤!`, weight: 4 },
              { text: `ğŸ¶ ê°•ì•„ì§€ê°€ ì‹ ë‚˜ê²Œ ë‹¬ë ¤ì˜¤ë©° ë¸Œëœì¹˜ë¥¼ ë¬¼ê³  ì™”ìŠµë‹ˆë‹¤! ì£¼ìš´ ë¸Œëœì¹˜ ì´ë¦„ì€ \`${branch_name}\` ğŸ¾`, weight: 3 },
              { text: `ğŸ± ê³ ì–‘ì´ê°€ í‚¤ë³´ë“œë¥¼ ë°Ÿë‹¤ê°€ ì‹¤ìˆ˜ë¡œâ€¦ \`${branch_name}\` ë¸Œëœì¹˜ë¥¼ ë§Œë“¤ì—ˆì–´ìš”. ğŸ˜¼`, weight: 3 },
              { text: `ğŸš€ ë¡œì¼“ì´ ë°œì‚¬ë˜ë©° ë‚¨ê¸´ í”ì  ì†ì—ì„œ \`${branch_name}\` ë¸Œëœì¹˜ê°€ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤! ğŸš€`, weight: 4 },
              { text: `ğŸ“š ë¨¼ì§€ ìŒ“ì¸ ë§ˆë²•ì±…ì„ ì—´ì ë¹›ê³¼ í•¨ê»˜ \`${branch_name}\` ë¸Œëœì¹˜ê°€ íŠ€ì–´ë‚˜ì™”ìŠµë‹ˆë‹¤! ğŸ“–âœ¨`, weight: 3 },
              { text: `ğŸ© ë§ˆìˆ ì‚¬ê°€ ëª¨ìë¥¼ íœ™ ì—´ìâ€¦ í† ë¼ ëŒ€ì‹  \`${branch_name}\` ë¸Œëœì¹˜ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤! ğŸ©ğŸ‡`, weight: 2 },
              { text: `ğŸ§ í­ê·„ì´ ë¯¸ë„ëŸ¬ì§€ë“¯ ë‹¬ë ¤ì™€ ë¸Œëœì¹˜ë¥¼ ì „í•´ì¤ë‹ˆë‹¤: \`${branch_name}\` ğŸ§â„ï¸`, weight: 2 },
              { text: `ğŸ’¨ğŸŒ´ ë‚˜ë¬´ê°€ í”ë“¤ë¦¬ë”ë‹ˆ ë¸Œëœì¹˜ê°€ íˆ­ ë–¨ì–´ì¡ŒìŠµë‹ˆë‹¤! ê·¸ê²Œ ë°”ë¡œ \`${branch_name}\` ğŸŒ³`, weight: 1 }
            ];

            function pickWeighted(items) {
              const total = items.reduce((sum, it) => sum + (it.weight || 1), 0);
              let r = Math.random() * total;
              for (const it of items) {
                r -= (it.weight || 1);
                if (r < 0) return it.text;
              }
              return items[items.length - 1].text; // fallback
            }

            const body = pickWeighted(messages);
            github.rest.issues.createComment({
              issue_number: issue_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
